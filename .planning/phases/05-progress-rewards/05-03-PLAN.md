---
phase: 05-progress-rewards
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/app.js
  - src/components/quiz/quiz-renderer.js
  - src/views/home.js
  - assets/styles/components.css
autonomous: true

must_haves:
  truths:
    - "User can toggle sound on/off via accessible button"
    - "Sound preference persists across sessions"
    - "Quiz completion triggers both confetti and sound"
    - "Correct/incorrect answers play appropriate sounds"
  artifacts:
    - path: "src/app.js"
      provides: "SoundManager initialization on first click"
      contains: "soundManager.init"
    - path: "src/components/quiz/quiz-renderer.js"
      provides: "Sound and confetti integration in quiz flow"
      contains: "celebrateQuizPass"
    - path: "src/views/home.js"
      provides: "Sound toggle button in header"
      contains: "sound-toggle"
  key_links:
    - from: "src/app.js"
      to: "src/services/sound.js"
      via: "import and init"
      pattern: "import.*soundManager"
    - from: "src/components/quiz/quiz-renderer.js"
      to: "src/components/celebration.js"
      via: "import celebrateQuizPass"
      pattern: "import.*celebration"
    - from: "src/components/quiz/quiz-renderer.js"
      to: "window.soundManager"
      via: "global singleton"
      pattern: "soundManager\\.play"
---

<objective>
Integrate sound toggle UI and wire up celebration effects to quiz system

Purpose: Complete the rewards system by connecting all components and providing user control
Output: Fully integrated progress celebration system with accessible mute toggle
</objective>

<execution_context>
@C:\Users\Furby\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Furby\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-progress-rewards/RESEARCH.md
@.planning/phases/05-progress-rewards/05-01-SUMMARY.md
@.planning/phases/05-progress-rewards/05-02-SUMMARY.md
@src/app.js
@src/components/quiz/quiz-renderer.js
@src/views/home.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize SoundManager in app.js on first interaction</name>
  <files>src/app.js</files>
  <action>
Add SoundManager initialization to app.js. The SoundManager must be initialized after:
1. StateManager is created (needs reference for mute preference)
2. User has interacted with page (autoplay policy)

Add imports at top:
```javascript
import { soundManager } from './services/sound.js';
```

After StateManager creation, set reference:
```javascript
// Existing: const state = new StateManager();
soundManager.setStateManager(state);

// Make available globally for quiz-renderer
window.soundManager = soundManager;
```

Add one-time click listener for initialization (can be near the end of init):
```javascript
// Initialize sound on first user interaction (autoplay policy)
document.addEventListener('click', () => {
    soundManager.init();
}, { once: true });
```

The { once: true } ensures init() only runs once, on first click anywhere.
  </action>
  <verify>
1. Load page, open console
2. Click anywhere
3. Console shows "SoundManager: Initialized with 4 sounds"
4. window.soundManager is available
  </verify>
  <done>SoundManager initializes on first click and is available globally</done>
</task>

<task type="auto">
  <name>Task 2: Add sound toggle button to home view</name>
  <files>src/views/home.js, assets/styles/components.css</files>
  <action>
Add a sound toggle button to the home view header. This follows the W3C ARIA APG toggle button pattern.

In home.js, add the toggle button to the header HTML:

```javascript
// In the template string, update the header section:
<header class="home-header">
    <div class="home-header-row">
        <h1>KI und ich</h1>
        <button
            type="button"
            class="sound-toggle"
            id="sound-toggle"
            aria-pressed="${state.get('soundEnabled') !== false}"
            aria-label="Ton"
            title="${state.get('soundEnabled') !== false ? 'Ton deaktivieren' : 'Ton aktivieren'}"
        >
            <span class="sound-toggle-icon" aria-hidden="true">
                ${state.get('soundEnabled') !== false ? 'ðŸ”Š' : 'ðŸ”‡'}
            </span>
        </button>
    </div>
    <p class="home-welcome">Willkommen! Lerne spielerisch, was Kuenstliche Intelligenz ist.</p>
</header>
```

Add event listener after innerHTML is set:
```javascript
// After container.innerHTML = `...`;
const soundToggle = container.querySelector('#sound-toggle');
if (soundToggle) {
    soundToggle.addEventListener('click', () => {
        const isMuted = soundToggle.getAttribute('aria-pressed') === 'true';
        const nowMuted = !isMuted;

        // Update state via soundManager
        if (window.soundManager) {
            window.soundManager.setMuted(nowMuted);
        } else {
            // Fallback: update state directly
            state.set('soundEnabled', !nowMuted);
        }

        // Update button appearance
        soundToggle.setAttribute('aria-pressed', !nowMuted);
        soundToggle.setAttribute('title', nowMuted ? 'Ton aktivieren' : 'Ton deaktivieren');
        soundToggle.querySelector('.sound-toggle-icon').textContent = nowMuted ? 'ðŸ”‡' : 'ðŸ”Š';

        // Play click sound to confirm (if turning on)
        if (!nowMuted && window.soundManager) {
            window.soundManager.play('click');
        }
    });
}
```

In components.css, add sound toggle styles:

```css
/* Sound toggle button */
.home-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-md);
}

.sound-toggle {
    min-width: 48px;
    min-height: 48px;
    padding: var(--space-sm);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sound-toggle:hover {
    border-color: var(--color-primary);
    background: var(--color-background-alt);
}

.sound-toggle:focus {
    outline: 3px solid rgba(88, 204, 2, 0.4);
    outline-offset: 2px;
}

.sound-toggle[aria-pressed="false"] {
    opacity: 0.7;
}

.sound-toggle-icon {
    line-height: 1;
}
```
  </action>
  <verify>
1. Navigate to home page
2. See sound toggle button in header (top right)
3. Click toggle - icon changes between speaker and muted
4. Refresh page - preference persists
  </verify>
  <done>Sound toggle button appears in home header with proper accessibility attributes</done>
</task>

<task type="auto">
  <name>Task 3: Integrate sounds and confetti into quiz-renderer</name>
  <files>src/components/quiz/quiz-renderer.js</files>
  <action>
Add celebration imports at top of file:
```javascript
import { celebrateQuizPass, celebratePerfectScore } from '../celebration.js';
```

In the handleAnswer() method, add sound after updating score:
```javascript
// After: if (isCorrect) { this.score++; }
// Play sound feedback
if (window.soundManager) {
    window.soundManager.play(isCorrect ? 'correct' : 'incorrect');
}
```

In the renderResults() method, add celebration effects. Find the section where score is saved and add:
```javascript
// After: this.saveScore();
// Trigger celebrations for passing score
if (this.score >= 3) {
    // Play completion sound
    if (window.soundManager) {
        window.soundManager.play('complete');
    }

    // Trigger confetti (different intensity based on score)
    if (this.score === this.quiz.questions.length) {
        celebratePerfectScore();  // 5/5 gets extra celebration
    } else {
        celebrateQuizPass();  // 3-4 gets standard celebration
    }
}
```

The integration points:
- handleAnswer(): lines ~117-127 (after isCorrect check)
- renderResults(): lines ~194-205 (after saveScore call)

Note: Kiki's reactToQuizEnd() already runs via quiz-complete event. The confetti and sound complement (not replace) Kiki's celebration.
  </action>
  <verify>
1. Start a quiz
2. Answer correctly - hear "correct" sound
3. Answer incorrectly - hear "incorrect" sound
4. Complete quiz with 3+ correct - confetti burst + "complete" sound + Kiki celebration
5. Complete quiz with 5/5 - extra confetti effect
  </verify>
  <done>Quiz plays sounds on answer and triggers confetti on pass</done>
</task>

</tasks>

<verification>
1. app.js imports and initializes soundManager
2. home.js renders accessible sound toggle in header
3. quiz-renderer.js imports celebration.js and calls celebrateQuizPass/celebratePerfectScore
4. Sound plays on correct/incorrect answers during quiz
5. Confetti + sound triggers when passing quiz
6. Mute toggle persists preference and prevents sounds when muted
</verification>

<success_criteria>
- Sound toggle button visible and accessible (48x48px min, aria-pressed)
- Toggle state persists across page refresh
- Quiz answer sounds play correctly
- Quiz pass (3+) triggers confetti + sound
- Perfect score (5/5) triggers enhanced confetti
- All feedback disabled when muted
- Kiki celebration still works alongside new effects
</success_criteria>

<output>
After completion, create `.planning/phases/05-progress-rewards/05-03-SUMMARY.md`
</output>
