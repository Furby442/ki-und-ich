---
phase: 05-progress-rewards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/sound.js
  - src/services/state.js
  - assets/audio/correct.mp3
  - assets/audio/incorrect.mp3
  - assets/audio/complete.mp3
  - assets/audio/click.mp3
autonomous: true

must_haves:
  truths:
    - "Sound effects play on user interactions when enabled"
    - "Sounds respect mute preference from state"
    - "SoundManager initializes on first user gesture (avoids autoplay block)"
  artifacts:
    - path: "src/services/sound.js"
      provides: "SoundManager class with Web Audio API"
      exports: ["SoundManager", "soundManager"]
    - path: "assets/audio/correct.mp3"
      provides: "Correct answer sound effect"
    - path: "assets/audio/incorrect.mp3"
      provides: "Incorrect answer sound effect"
    - path: "assets/audio/complete.mp3"
      provides: "Quiz completion celebration sound"
    - path: "assets/audio/click.mp3"
      provides: "UI click sound effect"
  key_links:
    - from: "src/services/sound.js"
      to: "src/services/state.js"
      via: "reads soundEnabled preference"
      pattern: "state\\.get\\('soundEnabled'\\)"
---

<objective>
Create SoundManager component with Web Audio API for audio feedback

Purpose: Provide motivational audio cues that enhance the learning experience for children
Output: SoundManager singleton service with preloaded sound buffers and mute support
</objective>

<execution_context>
@C:\Users\Furby\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Furby\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-progress-rewards/RESEARCH.md
@src/services/state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add soundEnabled preference to StateManager</name>
  <files>src/services/state.js</files>
  <action>
Update the getDefaultState() method to include soundEnabled preference:
```javascript
getDefaultState() {
    return {
        currentLesson: 0,
        completedLessons: [],
        quizScores: {},
        lastVisited: null,
        soundEnabled: true  // NEW: default to sounds on
    };
}
```
No other changes needed - StateManager already handles persistence and merging defaults.
  </action>
  <verify>Grep for "soundEnabled" in state.js shows the new field</verify>
  <done>StateManager includes soundEnabled in default state</done>
</task>

<task type="auto">
  <name>Task 2: Create audio files directory and placeholder sounds</name>
  <files>assets/audio/correct.mp3, assets/audio/incorrect.mp3, assets/audio/complete.mp3, assets/audio/click.mp3</files>
  <action>
Create the assets/audio/ directory and download free UI sound effects. Use simple, short sounds (~0.5s each) that are child-friendly:

1. Create directory: assets/audio/
2. Download 4 MP3 files from Pixabay (royalty-free):
   - correct.mp3: Positive "ding" or chime sound
   - incorrect.mp3: Soft "buzz" or gentle negative tone (not harsh)
   - complete.mp3: Celebratory fanfare or success jingle
   - click.mp3: Soft button click or pop sound

Use curl to download from Pixabay's free sound effects:
```bash
mkdir -p assets/audio
# Download appropriate sounds (URLs will be actual Pixabay direct links)
```

If direct download not possible, create a simple note file explaining where to get sounds:
- https://pixabay.com/sound-effects/search/correct/
- https://pixabay.com/sound-effects/search/wrong/
- https://pixabay.com/sound-effects/search/success/
- https://pixabay.com/sound-effects/search/click/

Keep each file under 10KB for fast loading.
  </action>
  <verify>ls assets/audio/ shows 4 .mp3 files</verify>
  <done>Audio assets directory exists with sound effect files</done>
</task>

<task type="auto">
  <name>Task 3: Create SoundManager service with Web Audio API</name>
  <files>src/services/sound.js</files>
  <action>
Create SoundManager class following the pattern from RESEARCH.md:

```javascript
/**
 * SoundManager - Web Audio API based sound effects
 *
 * Uses single AudioContext (singleton pattern) with preloaded buffers.
 * Respects soundEnabled preference from StateManager.
 * Must be initialized after first user gesture to comply with autoplay policy.
 */

export class SoundManager {
    constructor() {
        this.audioContext = null;
        this.buffers = {};
        this.initialized = false;
        this.stateManager = null;
    }

    /**
     * Set the state manager reference
     * Called from app.js after state is created
     */
    setStateManager(stateManager) {
        this.stateManager = stateManager;
    }

    /**
     * Initialize audio context and preload sounds
     * MUST be called after user gesture (click/tap)
     */
    async init() {
        if (this.initialized) return;

        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // Resume if suspended (autoplay policy)
            if (this.audioContext.state === 'suspended') {
                await this.audioContext.resume();
            }

            // Preload all sounds in parallel
            await Promise.all([
                this.loadSound('correct', 'assets/audio/correct.mp3'),
                this.loadSound('incorrect', 'assets/audio/incorrect.mp3'),
                this.loadSound('complete', 'assets/audio/complete.mp3'),
                this.loadSound('click', 'assets/audio/click.mp3')
            ]);

            this.initialized = true;
            console.log('SoundManager: Initialized with', Object.keys(this.buffers).length, 'sounds');
        } catch (error) {
            console.warn('SoundManager: Failed to initialize', error);
        }
    }

    /**
     * Load a sound file into buffer
     */
    async loadSound(name, url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const arrayBuffer = await response.arrayBuffer();
            this.buffers[name] = await this.audioContext.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.warn(`SoundManager: Failed to load ${name}`, error);
        }
    }

    /**
     * Play a sound by name
     * Respects mute preference, silently fails if sound not loaded
     */
    play(name) {
        // Check mute preference
        if (this.stateManager && this.stateManager.get('soundEnabled') === false) {
            return;
        }

        // Check if sound exists
        if (!this.audioContext || !this.buffers[name]) {
            return;
        }

        // Create new source node (single-use)
        const source = this.audioContext.createBufferSource();
        source.buffer = this.buffers[name];
        source.connect(this.audioContext.destination);
        source.start(0);
    }

    /**
     * Set muted state
     */
    setMuted(muted) {
        if (this.stateManager) {
            this.stateManager.set('soundEnabled', !muted);
        }
    }

    /**
     * Check if muted
     */
    isMuted() {
        if (!this.stateManager) return false;
        return this.stateManager.get('soundEnabled') === false;
    }

    /**
     * Check if initialized
     */
    isReady() {
        return this.initialized;
    }
}

// Singleton instance
export const soundManager = new SoundManager();
export default soundManager;
```

Key implementation notes:
- Uses singleton pattern like window.kiki
- Handles both AudioContext and webkitAudioContext for Safari
- Gracefully handles missing sounds without throwing
- Creates new BufferSourceNode per playback (required - nodes are single-use)
- Lazy initialization triggered by first user interaction
  </action>
  <verify>
Test in browser console:
1. Load page
2. Click anywhere
3. Run: window.soundManager.play('click')
4. Sound should play (if audio files exist)
  </verify>
  <done>SoundManager service exports singleton with init(), play(), setMuted(), isMuted() methods</done>
</task>

</tasks>

<verification>
1. src/services/state.js includes soundEnabled: true in getDefaultState()
2. src/services/sound.js exports SoundManager class and soundManager singleton
3. assets/audio/ directory exists with 4 MP3 files (or placeholder instructions)
4. SoundManager follows Web Audio API best practices from RESEARCH.md
</verification>

<success_criteria>
- SoundManager can be imported and initialized
- play() method works for all 4 sound types when enabled
- play() is silent when soundEnabled is false
- No errors when audio files are missing (graceful degradation)
</success_criteria>

<output>
After completion, create `.planning/phases/05-progress-rewards/05-01-SUMMARY.md`
</output>
