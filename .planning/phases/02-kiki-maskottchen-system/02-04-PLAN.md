---
phase: 02-kiki-maskottchen-system
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app.js
  - src/components/kiki/kiki.js
  - assets/styles/kiki.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Kiki greets user when website loads on home page"
    - "Kiki shows proud/happy emotion when answer is correct"
    - "Kiki shows thoughtful emotion when answer is incorrect"
  artifacts:
    - path: "src/app.js"
      provides: "Kiki initialization before Router"
      min_lines: 86
    - path: "src/components/kiki/kiki.js"
      provides: "reactToAnswer sets correct emotions"
      contains: "EMOTIONS.PROUD"
    - path: "assets/styles/kiki.css"
      provides: "Emotion CSS with higher specificity than blink"
      contains: "data-emotion"
  key_links:
    - from: "src/app.js"
      to: "window.kiki"
      via: "initialization order"
      pattern: "window.kiki.*init.*Router"
    - from: "src/components/kiki/kiki.js"
      to: "kiki.js:244-256"
      via: "reactToAnswer emotion setting"
      pattern: "setEmotion.*EMOTIONS\\.(PROUD|THOUGHTFUL)"
    - from: "assets/styles/kiki.css"
      to: "emotion transforms"
      via: "CSS specificity"
      pattern: "\\[data-emotion.*\\].*transform"
---

<objective>
Fix 3 UAT-identified issues with Kiki mascot system to ensure proper greeting, correct answer celebration, and incorrect answer encouragement.

Purpose: Resolve race condition preventing home greeting and fix emotion display issues during quiz reactions
Output: Working Kiki greeting on load, correct emotions displayed for quiz answers
</objective>

<execution_context>
@C:\Users\Furby\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Furby\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\Furby\.claude/.planning/PROJECT.md
@C:\Users\Furby\.claude/.planning/ROADMAP.md
@C:\Users\Furby\.claude/.planning/STATE.md

# Prior Phase Summaries (for context)
@C:\Users\Furby\.claude/.planning/phases/02-kiki-maskottchen-system/02-02-PLAN.md

# Files to modify
@C:\Users\Furby\.claude/src/app.js
@C:\Users\Furby\.claude/src/components/kiki/kiki.js
@C:\Users\Furby\.claude/assets/styles/kiki.css
</context>

<tasks>

<task type="auto">
  <name>Fix Kiki initialization race condition</name>
  <files>src/app.js</files>
  <action>
  Move Kiki initialization BEFORE Router initialization in src/app.js.

  Current order (BROKEN):
  - Line 60: `const router = new Router(routes);`
  - Lines 62-64: Kiki init + assign to window.kiki

  Fixed order:
  - Initialize Kiki and assign to window.kiki FIRST
  - THEN initialize Router

  Why: Router immediately triggers route handler (HomeView). HomeView checks window.kiki and shows greeting if defined. Race condition caused window.kiki to be undefined when HomeView ran.

  Implementation:
  1. Move lines 62-64 (Kiki init) to BEFORE line 60 (Router init)
  2. Keep all other code unchanged
  3. Ensure window.kiki is assigned BEFORE `new Router(routes)` call

  Result: window.kiki exists when HomeView runs, greeting displays correctly.
  </action>
  <verify>
  ```bash
  # Check initialization order in app.js
  grep -n "window.kiki\|new Router" src/app.js
  # Should show window.kiki assignment before Router instantiation
  ```
  </verify>
  <done>
  In src/app.js, kikiInstance.init() and window.kiki assignment occur BEFORE new Router(routes) instantiation. Lines confirm: window.kiki = kikiInstance appears at lower line number than const router = new Router(routes).
  </done>
</task>

<task type="auto">
  <name>Fix reactToAnswer emotion CSS specificity</name>
  <files>assets/styles/kiki.css</files>
  <action>
  Fix CSS specificity issue where `.kiki-eye` blink animation overrides emotion-based transforms.

  Root cause: Line 102-108 apply `animation: kiki-blink` to all `.kiki-eye` elements. When emotion changes (e.g., `data-emotion="proud"`), the emotion CSS tries to set `transform: scaleY(0.7)` on `.kiki-eye`, but the blink animation's transform overrides it.

  Solution: Use `animation: none` for emotions that need specific eye transforms.

  Changes needed:

  1. Line 156-158 (Proud emotion) - Already has `animation: none` ✓
  2. Line 129-134 (Thoughtful emotion) - Add `animation: none` to prevent blink from overriding transforms
  3. Verify all emotion states that set eye transforms disable blink animation

  Implementation:
  - Add `animation: none;` to `.kiki-avatar[data-emotion="thoughtful"] .kiki-eye` block
  - This prevents blink animation from fighting with thoughtful eye transforms (translateY, scaleY)

  Why: CSS specificity is same for `.kiki-eye` and `.kiki-avatar[data-emotion="thoughtful"] .kiki-eye`, but animations can't be "partially overridden" - must disable entirely.
  </action>
  <verify>
  ```bash
  # Check that thoughtful emotion disables blink animation
  grep -A 10 "data-emotion=\"thoughtful\"" assets/styles/kiki.css | grep "animation: none"
  ```
  </verify>
  <done>
  In assets/styles/kiki.css, `.kiki-avatar[data-emotion="thoughtful"] .kiki-eye` rule includes `animation: none;` to prevent blink animation from overriding emotion transforms.
  </done>
</task>

<task type="auto">
  <name>Verify reactToAnswer emotion setting logic</name>
  <files>src/components/kiki/kiki.js</files>
  <action>
  Verify that reactToAnswer() method correctly sets emotions for correct and incorrect answers.

  Check src/components/kiki/kiki.js lines 239-262:

  Expected behavior:
  - `reactToAnswer(true)` → setEmotion(EMOTIONS.PROUD) on line 244
  - `reactToAnswer(false)` → setEmotion(EMOTIONS.THOUGHTFUL) on line 256

  If logic is correct (which it appears to be from prior read), NO CODE CHANGES needed. This task is verification only.

  If logic is incorrect:
  - Ensure line 244 calls `this.setEmotion(EMOTIONS.PROUD)` for correct answers
  - Ensure line 256 calls `this.setEmotion(EMOTIONS.THOUGHTFUL)` for incorrect answers

  Why we're checking: UAT reported emotion not displaying correctly, but after fixing CSS specificity issue (Task 2), the JS logic should work. This confirms the JS is correct and issue was purely CSS.
  </action>
  <verify>
  ```bash
  # Verify emotion setting in reactToAnswer method
  sed -n '239,262p' src/components/kiki/kiki.js | grep -E "setEmotion.*PROUD|setEmotion.*THOUGHTFUL"
  # Should show PROUD for correct (true branch) and THOUGHTFUL for incorrect (false branch)
  ```
  </verify>
  <done>
  In src/components/kiki/kiki.js, reactToAnswer() method correctly calls setEmotion(EMOTIONS.PROUD) for correct answers and setEmotion(EMOTIONS.THOUGHTFUL) for incorrect answers. Logic is verified correct.
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify fixes work:

1. **Greeting on load:**
   - Open browser DevTools console
   - Navigate to home page (clear cache if needed)
   - Verify console shows no errors about window.kiki being undefined
   - Verify Kiki speech bubble appears with greeting message

2. **Correct answer emotion:**
   - Navigate to any quiz
   - Answer a question correctly
   - Verify Kiki displays PROUD emotion (big smile, squinted eyes, puffed chest)
   - Verify particles/stars appear
   - Verify encouraging message displays

3. **Incorrect answer emotion:**
   - Answer a question incorrectly
   - Verify Kiki displays THOUGHTFUL emotion (tilted head, contemplative pose)
   - Verify encouraging message displays

Run manual UAT again to confirm all 3 issues resolved.
</verification>

<success_criteria>
- Kiki greeting displays immediately when website loads on home page
- reactToAnswer(true) displays proud/happy emotion with celebration animation
- reactToAnswer(false) displays thoughtful emotion with encouragement
- No race conditions in initialization order
- CSS specificity allows emotion transforms to override idle animations
</success_criteria>

<output>
After completion, create `.planning/phases/02-kiki-maskottchen-system/02-04-SUMMARY.md`
</output>
