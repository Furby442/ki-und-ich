---
phase: 02-kiki-maskottchen-system
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/kiki/kiki-particles.js
  - src/components/kiki/kiki.js
  - src/views/lesson.js
  - src/views/quiz.js
  - assets/styles/kiki.css
autonomous: true

must_haves:
  truths:
    - "Kiki reacts with animations when user answers quiz questions"
    - "Correct answers trigger celebration (happy emotion, thumbs up, particles)"
    - "Wrong answers trigger encouragement (thoughtful emotion, wave, supportive message)"
    - "Kiki shows contextual emotions on lesson and quiz pages"
  artifacts:
    - path: "src/components/kiki/kiki-particles.js"
      provides: "Particle effects for celebrations"
      exports: ["KikiParticles"]
    - path: "src/views/quiz.js"
      provides: "Quiz view with Kiki reactions"
      contains: "kiki.reactToAnswer"
  key_links:
    - from: "src/components/kiki/kiki.js"
      to: "src/components/kiki/kiki-particles.js"
      via: "import KikiParticles"
      pattern: "import.*KikiParticles.*from"
    - from: "src/views/quiz.js"
      to: "window.kiki"
      via: "reaction on answer"
      pattern: "kiki\\.react"
---

<objective>
Add quiz reaction animations with particle effects and integrate Kiki contextually into lesson/quiz views.

Purpose: Kiki's reactions to quiz answers provide emotional feedback that makes learning feel rewarding. Celebrations for correct answers and gentle encouragement for mistakes follow Duolingo's proven motivational pattern.

Output: Particle effects system, reactToAnswer() method for quiz feedback, contextual Kiki integration in lesson and quiz views.
</objective>

<execution_context>
@C:\Users\Furby\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Furby\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-kiki-maskottchen-system/02-CONTEXT.md
@.planning/phases/02-kiki-maskottchen-system/02-RESEARCH.md
@.planning/phases/02-kiki-maskottchen-system/02-01-SUMMARY.md
@.planning/phases/02-kiki-maskottchen-system/02-02-SUMMARY.md
@src/components/kiki/kiki.js
@src/views/lesson.js
@src/views/quiz.js
@assets/styles/kiki.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Particle Effects System</name>
  <files>
    - src/components/kiki/kiki-particles.js
    - assets/styles/kiki.css
  </files>
  <action>
Create lightweight particle effects manager for celebration animations.

KikiParticles class (kiki-particles.js):
- Constructor: Takes container element reference
- burst(type, options): Trigger particle burst effect
  - type: 'stars' (default celebration)
  - options: { count: 8, origin: { x: 75, y: 40 } }
- createParticle(type, origin, index, total): Internal method to create single particle

Particle creation:
- Create div with class "kiki-particle kiki-particle--{type}"
- Calculate burst direction: angle = (index / total) * 2 * PI
- Set CSS custom properties --tx, --ty for animation end position
- Apply random variation to distance (40-70px)
- Bias trajectory upward (ty -= 20)
- Add .kiki-particle--animating class via requestAnimationFrame
- Remove particle on animationend event

Reduced motion check:
- Check matchMedia('(prefers-reduced-motion: reduce)') before creating particles
- If true, skip particle creation entirely

CSS additions to kiki.css:

Particle container:
- .kiki-particles: position absolute, full size of kiki-container, pointer-events none, overflow visible

Particle base:
- .kiki-particle: position absolute, opacity 0, pointer-events none

Star shape:
- .kiki-particle--star: 12px size, gold/orange color (--kiki-accent)
- Use clip-path: polygon() for 10-point star shape

Animation:
- @keyframes particle-burst: opacity 1->0, transform translate(var(--tx), var(--ty)) scale(0.5->1)
- Duration: 0.8s ease-out
- .kiki-particle--animating applies animation

Reduced motion:
- .kiki-particle { display: none } in prefers-reduced-motion query
  </action>
  <verify>
File exists at src/components/kiki/kiki-particles.js. In browser with kiki container visible: create particle system, call burst('stars'), see 8 star particles explode outward and fade. Enable reduced-motion in DevTools - no particles appear.
  </verify>
  <done>
KikiParticles class creates celebration particle bursts. Star particles explode outward from origin with smooth animation. System respects reduced-motion preference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Quiz Reaction Methods to Kiki Controller</name>
  <files>
    - src/components/kiki/kiki.js
    - assets/styles/kiki.css
  </files>
  <action>
Extend Kiki controller with reaction methods for quiz feedback.

Import and integrate KikiParticles:
- Import { KikiParticles } from './kiki-particles.js'
- In init(): Create particles container, initialize this.particles = new KikiParticles(container)

New reaction method:
- reactToAnswer(correct: boolean): Main reaction method for quiz answers
  - If correct:
    1. Set emotion to 'proud'
    2. Add data-reaction="correct" attribute (triggers thumbs-up animation)
    3. Trigger particle burst
    4. Speak encouraging message: "Super gemacht!" or "Toll!" or "Richtig!"
  - If incorrect:
    1. Set emotion to 'thoughtful' (encouraging, not sad)
    2. Add data-reaction="encourage" attribute (triggers wave animation)
    3. Speak supportive message: "Kein Problem, versuch es nochmal!" or "Fast! Probier nochmal!"
  - After 2 seconds, remove data-reaction attribute (reset arm animation)

Message variety:
- Create arrays of 3-4 messages for correct/incorrect
- Randomly select one each time for variety

CSS additions for arm animations:
- @keyframes thumbs-up: rotate arm up gesture (0->-15deg->15deg->0) over 0.6s
- @keyframes wave: friendly wave (rotate -10deg->10deg) over 0.8s, 2 iterations
- .kiki-avatar[data-reaction="correct"] .kiki-arm--right { animation: thumbs-up }
- .kiki-avatar[data-reaction="encourage"] .kiki-arm--right { animation: wave }
- transform-origin on arm for natural rotation point

New method for quiz end:
- reactToQuizEnd(score, total): Special reaction for quiz completion
  - If score >= 3 (out of 5): emotion 'proud', particle burst, "Super! Du hast {score} von {total} richtig!"
  - If score < 3: emotion 'thoughtful' (encouraging), "Das war schon gut! Versuch die Lektion nochmal!"
  </action>
  <verify>
In console: window.kiki.reactToAnswer(true) - Kiki shows proud, thumbs up animation, particles, speaks praise. window.kiki.reactToAnswer(false) - Kiki shows thoughtful, wave animation, speaks encouragement. window.kiki.reactToQuizEnd(4, 5) - celebration. window.kiki.reactToQuizEnd(2, 5) - gentle encouragement.
  </verify>
  <done>
Kiki controller has reactToAnswer() and reactToQuizEnd() methods. Correct answers trigger celebration with particles and thumbs-up. Wrong answers trigger encouragement with wave. Messages vary randomly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Kiki Context into Lesson and Quiz Views</name>
  <files>
    - src/views/lesson.js
    - src/views/quiz.js
  </files>
  <action>
Add contextual Kiki behavior to lesson and quiz views.

LessonView updates:
- At end of render, set Kiki emotion based on lesson:
  - Lesson 1: 'curious' (first lesson, introducing concepts)
  - Lessons 2-6: 'happy' (standard learning)
  - Lesson 7: 'proud' (final lesson, building app)
- Add brief encouraging message on first visit to each lesson (per session):
  - Use sessionStorage key: 'kiki_lesson_{id}_visited'
  - Messages: "Lektion {id} - das wird spannend!" (lesson 1), "Weiter geht's!" (others)
  - Speak after 300ms delay

QuizView updates:
- On quiz page load, set emotion to 'curious' (waiting for answers)
- Prepare hook for future quiz system:
  - Add comment block showing where to call reactToAnswer()
  - Add placeholder function answerQuestion(correct) that calls kiki.reactToAnswer(correct)
  - Export this function for Phase 4 quiz system to use
- On viewing quiz results (placeholder for now):
  - Add comment showing where to call reactToQuizEnd(score, total)

Important: Phase 4 will implement actual quiz logic. This plan only adds:
1. Kiki contextual emotions on page load
2. Public methods/hooks that Phase 4 will invoke
3. Demo capability to test reactions manually

Code pattern for quiz.js:
```javascript
// Export for Phase 4 quiz system
export function answerQuestion(correct) {
    if (window.kiki) {
        window.kiki.reactToAnswer(correct);
    }
}

// Export for Phase 4 quiz completion
export function completeQuiz(score, total) {
    if (window.kiki) {
        window.kiki.reactToQuizEnd(score, total);
    }
}
```
  </action>
  <verify>
Navigate to lesson/1 - Kiki shows 'curious' emotion, speaks welcome message on first visit. Navigate away and back - no repeated message. Navigate to lesson/2 - Kiki shows 'happy'. Navigate to quiz/1 - Kiki shows 'curious'. Console: answerQuestion(true) triggers correct reaction. Console: answerQuestion(false) triggers encourage reaction.
  </verify>
  <done>
Lesson views show contextual Kiki emotions with brief messages on first visit. Quiz views set curious emotion and export answerQuestion() and completeQuiz() functions ready for Phase 4 integration.
  </done>
</task>

</tasks>

<verification>
Overall Phase Verification - Complete Phase 2 Test Suite:

KIKI-01 (SVG on every page):
1. Home page - Kiki visible bottom-left
2. Lesson/1 - Kiki visible
3. Quiz/1 - Kiki visible
4. All navigation transitions - Kiki persists (no flicker/re-render)

KIKI-02 (6 emotions):
5. Console: test all emotions - window.kiki.setEmotion('happy/thoughtful/proud/sad/surprised/curious')
6. Each emotion visually distinct (eyes, mouth, antenna, body)
7. Transitions smooth (0.8s)

KIKI-03 (Speech bubbles):
8. Home page greeting appears on fresh session
9. Console: window.kiki.speak('Test') shows bubble
10. Word-by-word animation visible
11. Dismiss button works
12. Mobile: bubble repositions appropriately

KIKI-04 (Quiz reactions):
13. Console: window.kiki.reactToAnswer(true) - proud, thumbs up, particles, praise
14. Console: window.kiki.reactToAnswer(false) - thoughtful, wave, encouragement
15. Console: window.kiki.reactToQuizEnd(4, 5) - celebration
16. Console: window.kiki.reactToQuizEnd(1, 5) - gentle encouragement

KIKI-05 (Home greeting):
17. Fresh session - greeting message appears
18. Message: "Hallo! Ich bin Kiki..."
19. Happy emotion during greeting
20. Does not repeat on return to home

Accessibility:
21. Toggle prefers-reduced-motion - all animations disabled
22. aria-label on Kiki SVG
23. Speech bubble has role="status" aria-live="polite"
</verification>

<success_criteria>
- Particle effects create celebration feeling without performance issues
- reactToAnswer(true) triggers full celebration sequence (emotion + animation + particles + speech)
- reactToAnswer(false) triggers supportive encouragement (emotion + wave + speech)
- Lesson views set appropriate contextual emotions
- Quiz views export hook functions for Phase 4 integration
- All 5 KIKI requirements (KIKI-01 through KIKI-05) met
- Phase 2 complete - Kiki is an engaging, emotionally responsive guide
</success_criteria>

<output>
After completion, create `.planning/phases/02-kiki-maskottchen-system/02-03-SUMMARY.md`
</output>
