---
phase: 02-kiki-maskottchen-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/kiki/kiki-speech.js
  - src/components/kiki/kiki.js
  - src/views/home.js
  - assets/styles/kiki.css
autonomous: true

must_haves:
  truths:
    - "Kiki shows speech bubble with text content"
    - "Speech bubble has word-by-word animation"
    - "User is greeted by Kiki on home page with welcoming message"
    - "Speech bubble can be dismissed"
  artifacts:
    - path: "src/components/kiki/kiki-speech.js"
      provides: "Speech bubble component with animation"
      exports: ["KikiSpeech"]
    - path: "src/views/home.js"
      provides: "Home view with Kiki greeting"
      contains: "kiki.speak"
  key_links:
    - from: "src/components/kiki/kiki.js"
      to: "src/components/kiki/kiki-speech.js"
      via: "import KikiSpeech"
      pattern: "import.*KikiSpeech.*from"
    - from: "src/views/home.js"
      to: "window.kiki"
      via: "greeting on load"
      pattern: "kiki\\.(speak|setEmotion)"
---

<objective>
Add speech bubble functionality to Kiki and implement the home page greeting.

Purpose: Speech bubbles are how Kiki communicates with children - short, friendly messages that make learning feel like a conversation. The home page greeting establishes Kiki as the friendly guide from the first moment.

Output: KikiSpeech component with animated text, speak() method on Kiki controller, and welcoming message on home page.
</objective>

<execution_context>
@C:\Users\Furby\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Furby\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-kiki-maskottchen-system/02-CONTEXT.md
@.planning/phases/02-kiki-maskottchen-system/02-RESEARCH.md
@.planning/phases/02-kiki-maskottchen-system/02-01-SUMMARY.md
@src/components/kiki/kiki.js
@src/components/kiki/kiki-avatar.js
@src/views/home.js
@assets/styles/kiki.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Speech Bubble Component</name>
  <files>
    - src/components/kiki/kiki-speech.js
    - assets/styles/kiki.css
  </files>
  <action>
Create KikiSpeech component that renders an animated speech bubble.

Component (kiki-speech.js):
- KikiSpeech(text, options) function returning HTML string
- Options: { animate: true, onDismiss: null }
- Splits text into words, wraps each in .kiki-speech-word span
- Each word gets animation-delay based on position (0.1s * index)
- Returns speech bubble HTML with dismiss button (X)

Structure:
```html
<div class="kiki-speech" role="status" aria-live="polite">
  <div class="kiki-speech-content">
    <span class="kiki-speech-word" style="animation-delay: 0s">Hallo!</span>
    <span class="kiki-speech-word" style="animation-delay: 0.1s">Ich</span>
    ...
  </div>
  <button class="kiki-speech-dismiss" aria-label="Schliessen">x</button>
</div>
```

CSS additions to kiki.css:
- .kiki-speech: positioned fixed, bottom: 220px, left: 100px (above Kiki)
- Use clip-path polygon for speech bubble tail pointing down-left toward Kiki
- max-width: 280px, min-width: 120px, white background, rounded corners
- Box shadow for depth, padding 12px 16px
- z-index: 950 (between kiki at 900 and nav at 1000)
- --visible class for opacity/transform animation (fade-in from bottom)

Word animation:
- .kiki-speech-word: inline-block, opacity 0, transform translateY(4px)
- @keyframes word-appear: opacity 0->1, translateY 4px->0 over 0.3s

Dismiss button:
- .kiki-speech-dismiss: absolute top-right, small X button, hover effect
- Clicking calls onDismiss callback

Reduced motion:
- .kiki-speech-word animation: none, opacity: 1 (instant display)

Mobile responsive:
- @media (max-width: 599px): left: 80px, bottom: 180px, max-width: 220px, smaller font
  </action>
  <verify>
File exists at src/components/kiki/kiki-speech.js. Import and call KikiSpeech('Test nachricht hier') returns HTML with .kiki-speech container and multiple .kiki-speech-word spans. CSS file contains .kiki-speech styles with clip-path and word-appear animation.
  </verify>
  <done>
KikiSpeech component generates speech bubble HTML with word-by-word animation setup. CSS includes positioning, tail shape, animations, and responsive adjustments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Speech into Kiki Controller</name>
  <files>
    - src/components/kiki/kiki.js
  </files>
  <action>
Extend Kiki controller class with speech bubble management.

New methods:
- speak(text, options = {}): Shows speech bubble with text
  - Options: { duration: 0, animate: true } (duration 0 = stays until dismissed)
  - Creates speech container if not exists, renders KikiSpeech HTML
  - Adds --visible class after render (triggers fade-in)
  - If duration > 0, auto-dismiss after duration ms
  - Handles dismiss button click to call hideSpeech()

- hideSpeech(): Removes --visible class, cleans up after transition

- isSpeaking(): Returns boolean if speech bubble is visible

Internal state:
- this.speechContainer: DOM element for speech bubble
- this.speechTimeout: Timer reference for auto-dismiss

Integration with init():
- Create speech container div (class="kiki-speech-container")
- Append after kiki-container in body

Event handling:
- Attach click listener for dismiss button using event delegation
- Clean up timeout on manual dismiss

Important: Do NOT re-render speech on every call - update innerHTML of existing container.
  </action>
  <verify>
Run app locally. In console: window.kiki.speak('Hallo, ich bin Kiki!') shows speech bubble with word animation. window.kiki.hideSpeech() removes it. window.kiki.speak('Test', { duration: 3000 }) auto-hides after 3 seconds.
  </verify>
  <done>
Kiki controller has speak(), hideSpeech(), and isSpeaking() methods. Speech bubble appears above Kiki with animation, can be dismissed manually or auto-hides after duration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Kiki Greeting to Home Page</name>
  <files>
    - src/views/home.js
  </files>
  <action>
Update HomeView to trigger Kiki greeting when user arrives.

Implementation:
- After container.innerHTML render, call greeting logic
- Set Kiki emotion to 'happy' for welcoming
- Call kiki.speak() with friendly German greeting

Greeting text (from CONTEXT - short, 1-2 sentences):
"Hallo! Ich bin Kiki, dein Roboter-Freund. Klick auf eine Lektion, um loszulegen!"

Timing:
- Add small delay (500ms setTimeout) so page renders first, then Kiki greets
- Use window.kiki reference (set by app.js)

Guard against repeated greetings:
- Only greet on FIRST visit to home in session
- Use sessionStorage flag: 'kiki_greeted'
- Check flag before greeting, set after greeting

Code pattern:
```javascript
// At end of HomeView function
if (!sessionStorage.getItem('kiki_greeted') && window.kiki) {
    setTimeout(() => {
        window.kiki.setEmotion('happy');
        window.kiki.speak('Hallo! Ich bin Kiki, dein Roboter-Freund. Klick auf eine Lektion, um loszulegen!');
        sessionStorage.setItem('kiki_greeted', 'true');
    }, 500);
}
```
  </action>
  <verify>
Open app in fresh browser tab (or clear sessionStorage). Navigate to home page. After 500ms delay, Kiki shows happy expression and speech bubble with greeting. Navigate away and back to home - no repeated greeting. Open new tab - greeting appears again (new session).
  </verify>
  <done>
Home page displays Kiki greeting on first visit per session. Kiki says welcoming message with happy emotion. Greeting does not repeat on subsequent home page visits within same session.
  </done>
</task>

</tasks>

<verification>
Overall Phase Verification:
1. Open fresh browser session, navigate to home page
2. Wait ~500ms, Kiki should show speech bubble: "Hallo! Ich bin Kiki..."
3. Words appear one by one with subtle animation
4. Click X to dismiss speech bubble - bubble fades out
5. Navigate to lesson/1 - no speech bubble, Kiki still visible
6. Navigate back to home - no repeated greeting
7. Console: window.kiki.speak('Test nachricht!') - new bubble appears
8. Console: window.kiki.speak('Auto hide', { duration: 2000 }) - hides after 2s
9. DevTools responsive mode: speech bubble repositions for mobile
10. Toggle prefers-reduced-motion: words appear instantly without animation
</verification>

<success_criteria>
- Speech bubble appears with chat-bubble styling and tail pointing to Kiki
- Word-by-word animation creates engaging text reveal effect
- Dismiss button (X) closes speech bubble
- Home page greeting fires once per session with welcoming message
- Kiki emotion set to 'happy' during greeting
- speak() method available via window.kiki for other views to use
- Mobile responsive positioning prevents content overlap
</success_criteria>

<output>
After completion, create `.planning/phases/02-kiki-maskottchen-system/02-02-SUMMARY.md`
</output>
