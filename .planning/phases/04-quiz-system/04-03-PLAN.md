---
phase: 04-quiz-system
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/quiz/quiz-renderer.js
  - assets/styles/quiz.css
  - src/views/quiz.js
autonomous: false

must_haves:
  truths:
    - "Correct answers show green pulse animation"
    - "Incorrect answers show orange shake animation (not red)"
    - "Correct answer is highlighted when user answers wrong"
    - "Results screen shows 'X von 5 richtig' score"
    - "Kiki celebrates on correct, encourages on incorrect"
    - "Quiz score is saved to StateManager"
  artifacts:
    - path: "src/components/quiz/quiz-renderer.js"
      provides: "Complete QuizRenderer with feedback and results"
      exports: ["QuizRenderer"]
    - path: "assets/styles/quiz.css"
      provides: "Feedback animations (pulse, shake)"
      contains: "@keyframes quiz-pulse"
    - path: "src/views/quiz.js"
      provides: "Updated quiz view using QuizRenderer"
      exports: ["QuizView", "answerQuestion", "completeQuiz"]
  key_links:
    - from: "src/components/quiz/quiz-renderer.js"
      to: "src/views/quiz.js"
      via: "answerQuestion and completeQuiz hooks"
      pattern: "answerQuestion|completeQuiz"
    - from: "src/views/quiz.js"
      to: "window.kiki"
      via: "reactToAnswer, reactToQuizEnd"
      pattern: "kiki\\.reactTo"
---

<objective>
Add feedback animations, results screen, and integrate quiz with Kiki and state management

Purpose: Complete the quiz experience with encouraging visual feedback, score display, and mascot reactions that motivate young learners

Output: Fully functional quiz system with animations, results, and Kiki integration
</objective>

<execution_context>
@C:\Users\Furby\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Furby\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quiz-system/04-02-SUMMARY.md
@src/views/quiz.js (existing hooks to use)
@src/components/kiki/kiki.js (reactToAnswer, reactToQuizEnd)
@.planning/phases/04-quiz-system/04-RESEARCH.md (animation CSS examples)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add feedback animations to quiz.css</name>
  <files>assets/styles/quiz.css</files>
  <action>
Add feedback animation styles to quiz.css:

```css
/* ========================================
   ANSWER FEEDBACK ANIMATIONS
   ======================================== */

/* Correct answer - gentle pulse with green */
@keyframes quiz-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); box-shadow: 0 0 20px var(--color-primary); }
    100% { transform: scale(1); }
}

.quiz-answer-btn--correct {
    animation: quiz-pulse 0.6s ease-in-out;
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
}

/* Incorrect answer - soft shake with ORANGE (not red - less punishing) */
@keyframes quiz-shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-8px); }
    40%, 80% { transform: translateX(8px); }
}

.quiz-answer-btn--incorrect {
    animation: quiz-shake 0.5s ease-in-out;
    background-color: var(--color-accent);  /* Orange, NOT red */
    border-color: var(--color-accent);
    color: white;
}

/* Show correct answer when user was wrong (subtle hint) */
.quiz-answer-btn--correct-hint {
    border-color: var(--color-primary);
    border-width: 4px;
    background-color: rgba(88, 204, 2, 0.1);  /* Light green tint */
}

/* ========================================
   RESULTS SCREEN
   ======================================== */

.quiz-complete {
    text-align: center;
    padding: var(--space-xl);
}

.quiz-complete h2 {
    font-size: var(--font-size-xl);
    color: var(--color-primary);
    margin-bottom: var(--space-lg);
}

.quiz-score {
    margin: var(--space-xl) 0;
}

.quiz-score-number {
    font-size: 64px;
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
}

.quiz-score-text {
    display: block;
    font-size: var(--quiz-font-size-base);
    color: var(--color-text-secondary);
    margin-top: var(--space-sm);
}

.quiz-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-top: var(--space-xl);
}

.quiz-actions .btn {
    min-height: 56px;
    font-size: var(--font-size-lg);
}

/* Reduced motion - disable animations */
@media (prefers-reduced-motion: reduce) {
    .quiz-answer-btn--correct,
    .quiz-answer-btn--incorrect {
        animation: none;
    }
}
```

Key requirements:
- Use --color-accent (orange) for incorrect, NOT --color-danger (red)
- Pulse animation is gentle (scale 1.05 max)
- Shake animation is small (8px movement)
- correct-hint class shows which answer was right when user was wrong
- Results score is large and celebratory
  </action>
  <verify>grep "@keyframes quiz-pulse" assets/styles/quiz.css returns the animation</verify>
  <done>Feedback animations use child-friendly orange (not red) and gentle movements</done>
</task>

<task type="auto">
  <name>Task 2: Complete QuizRenderer with feedback logic and results screen</name>
  <files>src/components/quiz/quiz-renderer.js</files>
  <action>
Update QuizRenderer to add feedback handling and results:

1. Update handleAnswer(answerId) method:
```javascript
handleAnswer(answerId) {
    if (this.answered) return;
    this.answered = true;

    const question = this.quiz.questions[this.currentQuestion];
    const selectedAnswer = question.answers.find(a => a.id === answerId);
    const isCorrect = selectedAnswer.correct === true;

    // Update score
    if (isCorrect) {
        this.score++;
    }

    // Get button elements
    const selectedBtn = this.container.querySelector(`[data-id="${answerId}"]`);
    const allBtns = this.container.querySelectorAll('.quiz-answer-btn');

    // Apply feedback classes
    selectedBtn.classList.add(isCorrect ? 'quiz-answer-btn--correct' : 'quiz-answer-btn--incorrect');

    // If wrong, show correct answer
    if (!isCorrect) {
        const correctId = question.answers.find(a => a.correct).id;
        this.container.querySelector(`[data-id="${correctId}"]`)
            .classList.add('quiz-answer-btn--correct-hint');
    }

    // Disable all buttons
    allBtns.forEach(btn => btn.disabled = true);

    // Show feedback text
    this.showFeedback(question.feedback, isCorrect);

    // Dispatch event for Kiki integration (quiz.js will handle)
    this.container.dispatchEvent(new CustomEvent('quiz-answer', {
        bubbles: true,
        detail: { correct: isCorrect, score: this.score }
    }));

    // Wait 2 seconds then next question (child needs time to absorb)
    setTimeout(() => this.nextQuestion(), 2000);
}
```

2. Add showFeedback method:
```javascript
showFeedback(feedback, isCorrect) {
    const feedbackEl = document.createElement('div');
    feedbackEl.className = 'quiz-feedback';
    feedbackEl.textContent = isCorrect ? feedback.correct : feedback.incorrect;
    this.container.querySelector('.quiz-question-text').after(feedbackEl);
}
```

3. Complete showResults method:
```javascript
showResults() {
    const { score, quiz } = this;
    const total = quiz.questions.length;
    const passed = score >= 3;

    // Save score to state
    const quizScores = this.state.get('quizScores') || {};
    quizScores[quiz.lessonId] = score;
    this.state.set('quizScores', quizScores);
    this.state.save();

    // Dispatch completion event for Kiki
    this.container.dispatchEvent(new CustomEvent('quiz-complete', {
        bubbles: true,
        detail: { score, total, passed }
    }));

    // Render results screen
    this.container.innerHTML = `
        <div class="quiz-complete">
            <h2>Quiz geschafft!</h2>
            <div class="quiz-score">
                <span class="quiz-score-number">${score}</span>
                <span class="quiz-score-text">von ${total} richtig</span>
            </div>
            <div class="quiz-actions">
                ${!passed ? `
                    <button class="btn btn-secondary quiz-retry-btn">
                        Nochmal versuchen
                    </button>
                ` : ''}
                <a href="#/lesson/${quiz.lessonId + 1}" class="btn btn-primary">
                    ${quiz.lessonId < 7 ? 'Weiter zur naechsten Lektion' : 'Zurueck zur Uebersicht'}
                </a>
            </div>
        </div>
    `;

    // Setup retry button if shown
    const retryBtn = this.container.querySelector('.quiz-retry-btn');
    if (retryBtn) {
        retryBtn.addEventListener('click', () => this.restart());
    }
}
```

4. Add restart method:
```javascript
restart() {
    this.currentQuestion = 0;
    this.score = 0;
    this.answered = false;
    this.render();
}
```

5. Add feedback styling to renderQuestion:
Add a placeholder element for feedback text that appears after answer selection.
  </action>
  <verify>QuizRenderer has handleAnswer with feedback classes, showResults with score display, restart method</verify>
  <done>QuizRenderer shows visual feedback, saves scores, allows retry on failure</done>
</task>

<task type="auto">
  <name>Task 3: Update quiz.js view to use QuizRenderer and Kiki hooks</name>
  <files>src/views/quiz.js</files>
  <action>
Update src/views/quiz.js to:

1. Import QuizRenderer and loadQuiz:
```javascript
import { Navigation } from '../components/navigation.js';
import { QuizRenderer } from '../components/quiz/quiz-renderer.js';
import { loadQuiz } from '../data/quiz-loader.js';
```

2. Update QuizView to async and use QuizRenderer:
```javascript
export async function QuizView(container, state, params) {
    const quizId = parseInt(params.id, 10);
    const lessonTitle = LESSON_TITLES[quizId] || 'Unbekannte Lektion';

    // Set Kiki to curious while loading
    if (window.kiki) {
        window.kiki.setEmotion('curious');
    }

    // Show loading state
    container.innerHTML = `
        <div class="container quiz-page">
            <header class="quiz-header">
                <div class="quiz-badge">Quiz ${quizId}</div>
                <h1>${lessonTitle}</h1>
            </header>
            <main class="quiz-content" id="quiz-container">
                <p>Quiz wird geladen...</p>
            </main>
        </div>
    `;

    try {
        // Load quiz data
        const quizData = await loadQuiz(quizId);

        // Get quiz container
        const quizContainer = document.getElementById('quiz-container');

        // Create and render quiz
        const quiz = new QuizRenderer(quizContainer, quizData, state);
        quiz.render();

        // Listen for quiz events to trigger Kiki
        quizContainer.addEventListener('quiz-answer', (e) => {
            answerQuestion(e.detail.correct);
        });

        quizContainer.addEventListener('quiz-complete', (e) => {
            completeQuiz(e.detail.score, e.detail.total);
        });

    } catch (error) {
        container.innerHTML = `
            <div class="container quiz-page">
                <p class="error">Quiz konnte nicht geladen werden.</p>
                <a href="#/lesson/${quizId}" class="btn">Zurueck zur Lektion</a>
            </div>
        `;
        console.error('Quiz load error:', error);
    }
}
```

3. Keep existing answerQuestion and completeQuiz hooks unchanged (they already call Kiki).

4. Export QuizView as default.
  </action>
  <verify>QuizView imports QuizRenderer, loadQuiz; renders quiz; hooks up quiz-answer and quiz-complete events to Kiki</verify>
  <done>quiz.js integrates QuizRenderer with Kiki reactions via existing hooks</done>
</task>

</tasks>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete quiz system with animations, score display, and Kiki reactions</what-built>
  <how-to-verify>
    1. Navigate to https://furby442.github.io/ki-und-ich/ (or local server)
    2. Click on Lesson 1 "Was ist KI?"
    3. Navigate through the lesson to the end and click "Zum Quiz"
    4. Answer each question and observe:
       - Correct answer shows green pulse animation
       - Incorrect answer shows orange shake (not red)
       - If wrong, correct answer is highlighted
       - Kiki reacts (celebrates or encourages)
       - 2-second pause before next question
    5. Complete all 5 questions
    6. Verify results screen shows "X von 5 richtig"
    7. If score < 3, verify "Nochmal versuchen" button appears
    8. Test retry functionality if available
    9. Check browser console for no errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</checkpoint>

<verification>
- [ ] Correct answers trigger green pulse animation
- [ ] Incorrect answers trigger orange shake animation
- [ ] Wrong selection shows correct answer highlighted
- [ ] Kiki celebrates on correct answers (reactToAnswer)
- [ ] Kiki encourages on incorrect answers (reactToAnswer)
- [ ] 2-second delay between questions for feedback absorption
- [ ] Results screen shows "X von 5 richtig" format
- [ ] Quiz score saved to state.quizScores[lessonId]
- [ ] Kiki reacts to quiz end (reactToQuizEnd)
- [ ] Retry button shown if score < 3
- [ ] No time pressure during quiz
</verification>

<success_criteria>
1. Visual feedback animations work on both correct and incorrect answers
2. Animations use child-friendly colors (green for correct, orange for wrong - no red)
3. Kiki reacts appropriately to each answer and quiz completion
4. Final score displays as "X von 5 richtig"
5. Quiz scores persist in StateManager
6. No console errors during quiz flow
7. Child-friendly pacing (2s delay, no timers)
</success_criteria>

<output>
After completion, create `.planning/phases/04-quiz-system/04-03-SUMMARY.md`
</output>
